# 状态机流程

检查逻辑是否存在错误，程序现象为每次从冷却状态结束进入 detection 状态后直接进入if len(detected_labels) != 0:会重复5次，原因未知，猜测可能是因为该物体出现检测推理就有5帧，我的猜测很有可能存在问题

两个状态 1. detection 2. cool

转化条件

1. 状态机初始化未 detection 状态，当检测到标签且打印该标签持续 3 秒两个条件满足转化为 cool 状态
2. cool 状态不执行任何代码，程序 sleep 2 秒，2 秒后转化为 detection 状态

源码:

```python


def main():
    args = parse_args()
    cfg = {
        "conf_thres": 0.4,
        "iou_thres": 0.5,
        "input_shape": [640, 640],
    }
    yaml_file = "data.yaml"
    with open(yaml_file, errors="ignore") as f:
        yaml_data = yaml.safe_load(f)

    class_names = yaml_data["names"]
    model = InferSession(args.device_id, args.model)

    cap = cv2.VideoCapture(0)
    if not cap.isOpened():
        print("Error: Could not open camera.")
        return

    F = 35  # Example focal length in mm, adjust this value as necessary
    H = 100  # Example actual height of object in mm, adjust this value as necessary

    State = "detection"

    while True:
        if State == "detection":
            print("Detection mode on going")
            ret, frame = cap.read()
            if not ret:
                print("Error: Failed to capture image.")
                break

            img_batch, scale_ratio, pad_size = preprocess_img(frame)
            img_batch = np.expand_dims(img_batch, axis=0)

            output = model.infer([img_batch])
            output = torch.tensor(output[0])
            boxout = nms(
                output, conf_thres=cfg["conf_thres"], iou_thres=cfg["iou_thres"]
            )

            pred_all = boxout[0].numpy()
            scale_coords(
                cfg["input_shape"],
                pred_all[:, :4],
                frame.shape,
                ratio_pad=(scale_ratio, pad_size),
            )

            detected_labels = draw_bbox(pred_all, class_names, F, H)

            if len(detected_labels) != 0:  # 如果检测到标签，即字符串非空
                start_time = time.time()
                end_time = start_time + 3

                while time.time() < end_time :  # 持续打印检测相同标签三秒钟，等价于停车三秒钟
                    print(detected_labels)

                State = "cool"  # 将状态机置为冷却状态


        if State == "cool":
            print("Cool mode is on going")
            time.sleep(2)
            # cooltime = time.time() + 2
            # while time.time() < cooltime:
            #     print("cooling_now...")
            State = "detection"

    cap.release()
    cv2.destroyAllWindows()

```



